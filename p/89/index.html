<!DOCTYPE HTML>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link rel="Stylesheet" type="text/css" href="/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/css/tango.css">
        <link rel="Stylesheet" type="text/css" href="/css/github-markdown.css">
        <title>涵曦 ~ 博客</title>
        <script src="/config.js"></script>
        <script src="/util.js"></script>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-139883805-2"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-139883805-2');
        </script>
    </head>

    <body>
        <div id="header">
            <div id="post-nav">
                <a href="/">首页</a>
                <a href="/about.html">关于</a>
                <a href="/sitemap.html">所有文章</a>
            </div>
        </div>
        <div id="container">
            <div id="title">pytest 实战</div>
            <div id="content" class="markdown-body">
                <blockquote>
<p>目的是使用 pytest 实现一套静态检查工具，采用 pytest 是因为一套完整的静态检查工具的产出的检查报告跟 pytest-html 产出的检查报告非常像，而且检查工具的每个步骤就相当于一个测试用例，并且测试用例直接可以有前后依赖关系。正式利用了 pytest 提供的这一套基础设施，可以比较方便的造出这个静态检查工具。</p>
</blockquote>
<p>工程目录结构如下：</p>
<pre class="notranslate"><code class="notranslate">.
├── gen_report.sh
├── install.sh
├── pytest-html
│   ├── codecov.yml
│   ├── docs
│   ├── Gruntfile.js
│   ├── LICENSE
│   ├── package.json
│   ├── Pipfile
│   ├── pyproject.toml
│   ├── README.rst
│   ├── setup.cfg
│   ├── setup.py
│   ├── src
│   ├── testing
│   └── tox.ini
├── reports
│   └── report.html
└── src
    ├── contest.py
    ├── init_test.py
    └── __pycache__
</code></pre>
<p>gen_report.sh 用于生成测试报告</p>
<div class="highlight highlight-source-shell"><pre class="notranslate">now=<span class="pl-s"><span class="pl-pds">$(</span>date +<span class="pl-s"><span class="pl-pds">"</span>%Y-%m-%d-%H-%M-%S<span class="pl-pds">"</span></span><span class="pl-pds">)</span></span>
<span class="pl-c"><span class="pl-c">#</span>pytest --html=reports/report-$now.html --self-contained-html src</span>
pytest --html=reports/report.html --self-contained-html src</pre></div>
<p>正式环境运行时，给生成的报告文件加上时间。为了方便测试，测试环境就不加时间了。</p>
<p>install.sh 用于安装 pytest-html 包，由于需要修改，所以直接把包引入工程目录了。</p>
<div class="highlight highlight-source-shell"><pre class="notranslate"><span class="pl-c1">cd</span> pytest-html
pip install -e <span class="pl-c1">.</span></pre></div>
<p>reports 目录用于存放生成的报告文件， src 目录用于存放测试用例。</p>
<p>接下来会根据制作静态检查工具所需的环境，对 pytest 以及 pytest-html 进行配置以及改造。</p>
<h2>获取命令行参数</h2>
<p>修改 src/contest.py 文件，使用 <code class="notranslate">pytest_addoption</code> 接口来新增参数：</p>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-k">import</span> <span class="pl-s1">pytest</span>
<span class="pl-k">def</span> <span class="pl-en">pytest_addoption</span>(<span class="pl-s1">parser</span>):
    <span class="pl-s1">parser</span>.<span class="pl-en">addoption</span>(
        <span class="pl-s">"--branch"</span>, <span class="pl-s1">action</span><span class="pl-c1">=</span><span class="pl-s">"store"</span>, <span class="pl-s1">default</span><span class="pl-c1">=</span><span class="pl-s">"master"</span>, <span class="pl-s1">help</span><span class="pl-c1">=</span><span class="pl-s">"branch: 分支名"</span>
    )

<span class="pl-en">@<span class="pl-s1">pytest</span>.<span class="pl-en">fixture</span>()</span>
<span class="pl-k">def</span> <span class="pl-en">branch</span>(<span class="pl-s1">request</span>):
    <span class="pl-k">return</span> <span class="pl-s1">request</span>.<span class="pl-s1">config</span>.<span class="pl-en">getoption</span>(<span class="pl-s">"--branch"</span>)</pre></div>
<p>并使用 <code class="notranslate">pytest.fixture</code> 装饰器新增一个 <code class="notranslate">branch</code> 参数给测试用例使用。</p>
<h2>配置测试用例直接的依赖关系</h2>
<p>想要某些测试用例依赖某些测试用例成功执行，可以使用 <code class="notranslate">pytest.mark.skipif</code> 实现，在满足第一个参数为 <code class="notranslate">True</code> 时跳过用例。</p>
<p>新键文件 <code class="notranslate">src/init_test.py</code> ，pytest 是会自动执行以 test 开始或者结尾的 py 文件的。</p>
<p>首先定义一个全局变量 <code class="notranslate">g_init_succ</code> 用来标记是否初始化完毕，然后用这个全局变量创建一个装饰器 <code class="notranslate">checkinit = pytest.mark.skipif(not g_init_succ, reason='初始化失败')</code> 。</p>
<p>接下来在第 1 个测试用例中，如果 <code class="notranslate">init()</code> 执行成功，则将 <code class="notranslate">g_init_succ</code> 设置为 <code class="notranslate">True</code> ，在第 2 个测试用例就可以使用前面创建的装饰器 <code class="notranslate">checkinit</code> 了。达到的效果就是 <code class="notranslate">init()</code> 执行成功，才执行第 2 个测试用例 <code class="notranslate">test_need_init</code> ，如果 <code class="notranslate">init()</code> 执行失败就不执行第 2 个测试用例了。</p>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-k">import</span> <span class="pl-s1">pytest</span>

<span class="pl-s1">g_init_succ</span> <span class="pl-c1">=</span> <span class="pl-c1">False</span>
<span class="pl-s1">checkinit</span> <span class="pl-c1">=</span> <span class="pl-s1">pytest</span>.<span class="pl-s1">mark</span>.<span class="pl-en">skipif</span>(<span class="pl-c1">not</span> <span class="pl-s1">g_init_succ</span>, <span class="pl-s1">reason</span><span class="pl-c1">=</span><span class="pl-s">'初始化失败'</span>)

<span class="pl-c"># 初始化环境</span>
<span class="pl-k">def</span> <span class="pl-en">init</span>():
    <span class="pl-c">#return True</span>
    <span class="pl-k">return</span> <span class="pl-c1">False</span>

<span class="pl-k">def</span> <span class="pl-en">test_init</span>(<span class="pl-s1">branch</span>):
    <span class="pl-k">global</span> <span class="pl-s1">g_init_succ</span>
    <span class="pl-en">print</span>(<span class="pl-s">"in test_init"</span>)
    <span class="pl-c"># branch 就是前面 fixture 装饰器创建的参数</span>
    <span class="pl-en">print</span>(<span class="pl-s">"branch:"</span>, <span class="pl-s1">branch</span>)
    <span class="pl-k">if</span> <span class="pl-en">init</span>():
        <span class="pl-s1">g_init_succ</span> <span class="pl-c1">=</span> <span class="pl-c1">True</span>
    <span class="pl-k">else</span>:
        <span class="pl-k">assert</span> <span class="pl-c1">False</span>, <span class="pl-s">"初始化环境失败"</span>
    <span class="pl-en">print</span>(<span class="pl-s">"init_succ"</span>, <span class="pl-s1">g_init_succ</span>)


<span class="pl-en">@<span class="pl-s1">checkinit</span></span>
<span class="pl-k">def</span> <span class="pl-en">test_need_init</span>():
    <span class="pl-en">print</span>(<span class="pl-s">"g_init_succ:"</span>, <span class="pl-s1">g_init_succ</span>)
    <span class="pl-en">print</span>(<span class="pl-s">"succ"</span>)
    <span class="pl-k">pass</span></pre></div>
<h2>变量比较多的情况怎么办？</h2>
<p>可以弄个 env 表，修改 <code class="notranslate">conftest.py</code> 文件：</p>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-en">@<span class="pl-s1">pytest</span>.<span class="pl-en">fixture</span>()</span>
<span class="pl-k">def</span> <span class="pl-en">env</span>(<span class="pl-s1">request</span>):
    <span class="pl-k">return</span> {
        <span class="pl-s">'branch'</span>: <span class="pl-s1">request</span>.<span class="pl-s1">config</span>.<span class="pl-en">getoption</span>(<span class="pl-s">"--branch"</span>),
        <span class="pl-s">'svn_root'</span>: <span class="pl-s">"http://test.com"</span>,
        <span class="pl-s">'svn_user'</span>: <span class="pl-s">"user"</span>,
        <span class="pl-s">'svn_passwd'</span>: <span class="pl-s">"passwd"</span>,
    }</pre></div>
<h2>修改 Environment 里显示的内容</h2>
<p>修改 <code class="notranslate">conftest.py</code> 文件：</p>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-k">def</span> <span class="pl-en">pytest_configure</span>(<span class="pl-s1">config</span>):
    <span class="pl-s1">config</span>.<span class="pl-s1">_metadata</span>.<span class="pl-en">clear</span>()
    <span class="pl-s1">config</span>.<span class="pl-s1">_metadata</span>[<span class="pl-s">'分支'</span>] <span class="pl-c1">=</span> <span class="pl-s1">config</span>.<span class="pl-en">getoption</span>(<span class="pl-s">'--branch'</span>)</pre></div>
<h2>删除 link 列</h2>
<p>修改 <code class="notranslate">conftest.py</code> 文件：</p>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-k">def</span> <span class="pl-en">pytest_html_results_table_header</span>(<span class="pl-s1">cells</span>):
    <span class="pl-s1">cells</span>.<span class="pl-en">pop</span>(<span class="pl-c1">-</span><span class="pl-c1">1</span>)  <span class="pl-c"># 删除link列</span>

<span class="pl-k">def</span> <span class="pl-en">pytest_html_results_table_row</span>(<span class="pl-s1">report</span>, <span class="pl-s1">cells</span>):
    <span class="pl-s1">cells</span>.<span class="pl-en">pop</span>(<span class="pl-c1">-</span><span class="pl-c1">1</span>)  <span class="pl-c"># 删除link列</span></pre></div>
<h2>修改标题</h2>
<div class="highlight highlight-source-python"><pre class="notranslate"><span class="pl-k">def</span> <span class="pl-en">pytest_html_report_title</span>(<span class="pl-s1">report</span>):
    <span class="pl-s1">report</span>.<span class="pl-s1">title</span> <span class="pl-c1">=</span> <span class="pl-s">"版本静态检查报告"</span></pre></div>
<h2>翻译成中文</h2>
<p>参考这篇文章： <a href="https://www.cnblogs.com/linuxchao/p/linuxchao-pytest-html.html" rel="nofollow">https://www.cnblogs.com/linuxchao/p/linuxchao-pytest-html.html</a><br>
翻译成果： <a href="https://github.com/hanxi/pytest-html-cn">https://github.com/hanxi/pytest-html-cn</a><br>
效果预览：</p>
<p><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/1185757/221254411-b30265ae-b944-4532-bed0-05b09ceac9d1.png"><img src="https://user-images.githubusercontent.com/1185757/221254411-b30265ae-b944-4532-bed0-05b09ceac9d1.png" alt="Pasted image 20230225014023" style="max-width: 100%;"></a></p>
<h2>待修改的地方</h2>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox"> 检查列显示内容优化，标题内容可以从单元测试的代码中获取</li>
<li class="task-list-item"><input type="checkbox" id="" disabled="" class="task-list-item-checkbox"> 详情内容优化，只显示 Captured stdout call 就够了，主要是因为上面的信息会自动输出 env 变量，里面含有 svn 密码这些敏感信息。下面的信息是手动打印出来的，可以由代码自由控制。</li>
</ul>
<h2>最后</h2>
<p>工具地址： <a href="https://github.com/hanxi/version-check-tool">https://github.com/hanxi/version-check-tool</a></p>
            </div>
            <div id="comment">
                <a href="https://github.com/hanxi/blog/issues/89#new_comment_field"> 点击进入评论 ... </a>
            </div>
        </div>
        <div id="footer"></div>
    </body>
    <script type="text/javascript">
        setFooter();
    </script>
 
</html>
